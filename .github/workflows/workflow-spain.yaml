name: "Build OpenStreetMaps for Garmin eTrex ğŸ›°ï¸"

on:
  push:
    branches: [ master ]
    paths-ignore:
      - 'README.md'
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * 5'

env:
  MKGMAP_VERSION: r4923
  SPLITTER_VERSION: r654

permissions:
  contents: write

jobs:
  build-map:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ•“ Set timezone to Europe/Madrid
        run: |
          sudo ln -sf /usr/share/zoneinfo/Europe/Madrid /etc/localtime
          echo "Europe/Madrid" | sudo tee /etc/timezone
          date

      - name: â˜• Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: ğŸ“¦ Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y osmium-tool nsis osmctools jq

      - name: ğŸ“ Create required directories
        run: mkdir -p data tools/mkgmap output output/peninsula output/canarias output/baleares bounds sea

      - name: ğŸŒ Get remote file date of Spain, Mainland ğŸ‡ªğŸ‡¸ PBF file
        id: remote-date-peninsula
        run: |
          URL="https://download.geofabrik.de/europe/spain-latest.osm.pbf"
          REMOTE_DATE=$(curl -sI "$URL" | grep -i '^last-modified:' | cut -d' ' -f2-)
          echo "REMOTE_DATE=$REMOTE_DATE" >> $GITHUB_OUTPUT

      - name: ğŸŒ Get remote file date of Spain, Canary Islands ğŸ‡®ğŸ‡¨ PBF file
        id: remote-date-canarias
        run: |
          URL="https://download.geofabrik.de/africa/canary-islands-latest.osm.pbf"
          REMOTE_DATE=$(curl -sI "$URL" | grep -i '^last-modified:' | cut -d' ' -f2-)
          echo "REMOTE_DATE=$REMOTE_DATE" >> $GITHUB_OUTPUT

      - name: ğŸŒ Get remote file date of Spain, Balearic Islands ğŸï¸ PBF file
        id: remote-date-baleares
        run: |
          URL="https://download.geofabrik.de/europe/spain/islas-baleares-latest.osm.pbf"
          REMOTE_DATE=$(curl -sI "$URL" | grep -i '^last-modified:' | cut -d' ' -f2-)
          echo "REMOTE_DATE=$REMOTE_DATE" >> $GITHUB_OUTPUT

      - name: ğŸ•’ Compare with local file date - Spain, Mainland ğŸ‡ªğŸ‡¸
        id: compare-dates-peninsula
        run: |
          FILE="data/spain-latest.osm.pbf"
          REMOTE_EPOCH=$(date -d "${{ steps.remote-date-peninsula.outputs.REMOTE_DATE }}" +%s)
          LOCAL_EPOCH=0
          if [ -f "$FILE" ]; then
            LOCAL_EPOCH=$(date -r "$FILE" +%s)
          fi

          if [ "$REMOTE_EPOCH" -gt "$LOCAL_EPOCH" ]; then
            echo "ğŸ’¾ Update available for Peninsula: downloading latest PBF file..."
            curl -L -o "$FILE" https://download.geofabrik.de/europe/spain-latest.osm.pbf
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No update needed for Peninsula, PBF file is already the latest version."
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ•’ Compare with local file date - Spain, Canary Islands ğŸ‡®ğŸ‡¨
        id: compare-dates-canarias
        run: |
          FILE="data/canary-islands-latest.osm.pbf"
          REMOTE_EPOCH=$(date -d "${{ steps.remote-date-canarias.outputs.REMOTE_DATE }}" +%s)
          LOCAL_EPOCH=0
          if [ -f "$FILE" ]; then
            LOCAL_EPOCH=$(date -r "$FILE" +%s)
          fi

          if [ "$REMOTE_EPOCH" -gt "$LOCAL_EPOCH" ]; then
            echo "ğŸ’¾ Update available for Canarias: downloading latest PBF file..."
            curl -L -o "$FILE" https://download.geofabrik.de/africa/canary-islands-latest.osm.pbf
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No update needed for Canarias, PBF file is already the latest version."
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ•’ Compare with local file date - Spain, Balearic Islands ğŸï¸
        id: compare-dates-baleares
        run: |
          FILE="data/islas-baleares-latest.osm.pbf"
          REMOTE_EPOCH=$(date -d "${{ steps.remote-date-baleares.outputs.REMOTE_DATE }}" +%s)
          LOCAL_EPOCH=0
          if [ -f "$FILE" ]; then
            LOCAL_EPOCH=$(date -r "$FILE" +%s)
          fi

          if [ "$REMOTE_EPOCH" -gt "$LOCAL_EPOCH" ]; then
            echo "ğŸ’¾ Update available for Baleares: downloading latest PBF file..."
            curl -L -o "$FILE" https://download.geofabrik.de/europe/spain/islas-baleares-latest.osm.pbf
            echo "downloaded=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No update needed for Baleares, PBF file is already the latest version."
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“… Fetch Geofabrik Europe page and parse Spain date
        id: release-getdate-osm
        run: |
          HTML=$(curl -s https://download.geofabrik.de/europe/spain.html)
          DATE_OSM=$(echo "$HTML" | grep -Po 'up to [0-9T:-]+Z' | head -n1 | cut -d' ' -f3)
          echo "DATE_OSM=$DATE_OSM" >> $GITHUB_OUTPUT

      - name: ğŸ“… Extract file date for version tag - Spain, Mainland ğŸ‡ªğŸ‡¸
        id: getdate-peninsula
        run: |
          DATE=$(date -r data/spain-latest.osm.pbf +'%Y-%m-%d' || date +'%Y-%m-%d')
          echo "DATE=$DATE" >> $GITHUB_OUTPUT

      - name: ğŸ“… Extract file date for version tag - Spain, Canary Islands ğŸ‡®ğŸ‡¨
        id: getdate-canarias
        run: |
          DATE=$(date -r data/canary-islands-latest.osm.pbf +'%Y-%m-%d' || date +'%Y-%m-%d')
          echo "DATE=$DATE" >> $GITHUB_OUTPUT

      - name: ğŸ“… Extract file date for version tag - Spain, Balearic Islands ğŸï¸
        id: getdate-baleares
        run: |
          DATE=$(date -r data/islas-baleares-latest.osm.pbf +'%Y-%m-%d' || date +'%Y-%m-%d')
          echo "DATE=$DATE" >> $GITHUB_OUTPUT

      - name: ğŸ› ï¸ Download and extract mkgmap ${{ env.MKGMAP_VERSION }}
        run: |
          curl -L https://www.mkgmap.org.uk/download/mkgmap-${{ env.MKGMAP_VERSION }}.tar.gz \
            | tar xz -C tools/mkgmap --strip-components=1

      - name: ğŸ› ï¸ Download and extract splitter ${{ env.SPLITTER_VERSION }}
        run: |
          mkdir -p tools/splitter
          curl -L https://www.mkgmap.org.uk/download/splitter-${{ env.SPLITTER_VERSION }}.tar.gz \
            | tar xz -C tools/splitter --strip-components=1

      - name: ğŸ“¦ Download and extract bounds and sea data
        run: |
          curl -L -o bounds.zip https://www.thkukuk.de/osm/data/bounds-latest.zip
          curl -L -o sea.zip https://www.thkukuk.de/osm/data/sea-latest.zip
          unzip -q bounds.zip -d bounds/
          unzip -q sea.zip -d sea/

      - name: ğŸ”€ Split PBF into tiles - Spain, Mainland ğŸ‡ªğŸ‡¸
        run: |
          mkdir -p split/peninsula
          java -Xmx6G -jar tools/splitter/splitter.jar \
            --max-nodes=800000 \
            --output-dir=split/peninsula \
            --keep-complete=true \
            data/spain-latest.osm.pbf

      - name: ğŸ”€ Split PBF into tiles - Spain, Canary Islands ğŸ‡®ğŸ‡¨
        run: |
          mkdir -p split/canarias
          java -Xmx6G -jar tools/splitter/splitter.jar \
            --max-nodes=800000 \
            --output-dir=split/canarias \
            --keep-complete=true \
            data/canary-islands-latest.osm.pbf

      - name: ğŸ”€ Split PBF into tiles - Spain, Balearic Islands ğŸï¸
        run: |
          mkdir -p split/baleares
          java -Xmx6G -jar tools/splitter/splitter.jar \
            --max-nodes=800000 \
            --output-dir=split/baleares \
            --keep-complete=true \
            data/islas-baleares-latest.osm.pbf
          
      - name: ğŸ§­ Build OSM map - Spain, Mainland ğŸ‡ªğŸ‡¸
        run: |
          java -Xmx8G -XX:+UseG1GC -jar tools/mkgmap/mkgmap.jar \
            --gmapsupp \
            --route \
            --index \
            --family-id=1001 \
            --product-id=1 \
            --family-name="OSM EspaÃ±a" \
            --series-name="OpenStreetMap - EspaÃ±a" \
            --mapname=63240001 \
            --overview-mapname=ESP_OVR \
            --description="Mapa EspaÃ±a, build ${{ steps.release-getdate-osm.outputs.DATE_OSM }}" \
            --country-name=EspaÃ±a \
            --country-abbr=ES \
            --region-name=EspaÃ±a \
            --output-dir=output/peninsula \
            --draw-priority=25 \
            --add-pois-to-areas \
            --link-pois-to-ways \
            --preserve-element-order \
            --bounds=bounds/ \
            --precomp-sea=sea/ \
            --generate-sea=polygons \
            --verbose \
            split/peninsula/*.osm.pbf

      - name: â™»ï¸ Rename gmapsupp.img to peninsula-gmapsupp.img
        run: |
          mv output/peninsula/gmapsupp.img output/peninsula/peninsula-gmapsupp.img

      - name: ğŸ§­ Build OSM map - Spain, Canary Islands ğŸ‡®ğŸ‡¨
        run: |
          java -Xmx8G -XX:+UseG1GC -jar tools/mkgmap/mkgmap.jar \
            --gmapsupp \
            --route \
            --index \
            --family-id=1002 \
            --product-id=1 \
            --family-name="OSM Canarias" \
            --series-name="OpenStreetMap - Canarias" \
            --mapname=63240002 \
            --overview-mapname=ESP_OVR_CAN \
            --description="Mapa Canarias, build ${{ steps.release-getdate-osm.outputs.DATE_OSM }}" \
            --country-name=EspaÃ±a \
            --country-abbr=ES \
            --region-name=Canarias \
            --output-dir=output/canarias \
            --draw-priority=25 \
            --add-pois-to-areas \
            --link-pois-to-ways \
            --preserve-element-order \
            --bounds=bounds/ \
            --precomp-sea=sea/ \
            --generate-sea=polygons \
            --verbose \
            split/canarias/*.osm.pbf

      - name: â™»ï¸ Rename gmapsupp.img to canarias-gmapsupp.img
        run: |
          mv output/canarias/gmapsupp.img output/canarias/canarias-gmapsupp.img

      - name: ğŸ§­ Build OSM map - Spain, Balearic Islands ğŸï¸
        run: |
          java -Xmx8G -XX:+UseG1GC -jar tools/mkgmap/mkgmap.jar \
            --gmapsupp \
            --route \
            --index \
            --family-id=1003 \
            --product-id=1 \
            --family-name="OSM Baleares" \
            --series-name="OpenStreetMap - Baleares" \
            --mapname=63240003 \
            --overview-mapname=ESP_OVR_BAL \
            --description="Mapa Baleares, build ${{ steps.release-getdate-osm.outputs.DATE_OSM }}" \
            --country-name=EspaÃ±a \
            --country-abbr=ES \
            --region-name=Baleares \
            --output-dir=output/baleares \
            --draw-priority=25 \
            --add-pois-to-areas \
            --link-pois-to-ways \
            --preserve-element-order \
            --bounds=bounds/ \
            --precomp-sea=sea/ \
            --generate-sea=polygons \
            --verbose \
            split/baleares/*.osm.pbf

      - name: â™»ï¸ Rename gmapsupp.img to baleares-gmapsupp.img
        run: |
          mv output/baleares/gmapsupp.img output/baleares/baleares-gmapsupp.img

      - name: ğŸš€ Publish combined release on GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.getdate-peninsula.outputs.DATE }}"
          name: "ğŸ—ºï¸ ${{ steps.release-getdate-osm.outputs.DATE_OSM }}"
          body: |
            ğŸ§­ Mapa compilado para Garmin eTrex 22x/30x/32x ğŸ›°ï¸
            ğŸ“… Fecha del build: `${{ steps.getdate-peninsula.outputs.DATE }}`
            ğŸ—ºï¸ Datos de OpenStreetMap: `${{ steps.release-getdate-osm.outputs.DATE_OSM }}`

            ---

            ### ğŸ·ï¸ Opciones de compilaciÃ³n

            | ğŸŒ RegiÃ³n    | ğŸ†” family-id | ğŸ·ï¸ family-name | ğŸ“¦ series-name               | ğŸ—ºï¸ mapname | ğŸ§¾ overview-mapname | ğŸ‡ªğŸ‡¸ country-name | ğŸŒ country-abbr | ğŸ—ºï¸ region-name | ğŸ“… Build Date |
            |--------------|--------------|----------------|------------------------------|------------|----------------------|------------------|------------------|----------------|----------------|
            | Peninsula    | 1001         | OSM EspaÃ±a     | OpenStreetMap - EspaÃ±a       | 63240001   | ESP_OVR             | EspaÃ±a           | ES               | EspaÃ±a         | ${{ steps.getdate-peninsula.outputs.DATE }} |
            | Canarias     | 1002         | OSM Canarias   | OpenStreetMap - Canarias     | 63240002   | ESP_OVR_CAN         | EspaÃ±a           | ES               | Canarias       | ${{ steps.getdate-canarias.outputs.DATE }} |            
            | Baleares     | 1003         | OSM Baleares   | OpenStreetMap - Baleares     | 63240003   | ESP_OVR_BAL         | EspaÃ±a           | ES               | Baleares       | ${{ steps.getdate-baleares.outputs.DATE }} |

            ---

            âš™ï¸ ParÃ¡metros en la compilaciÃ³n:

            - ğŸ—ºï¸ Generar archivo `gmapsupp.img` (`--gmapsupp`)
            - ğŸ§­ Ruteable (`--route`)
            - ğŸ” Ãndice de bÃºsqueda (`--index`)
            - ğŸ§¾ `product-id: 1`
            - ğŸ“Š `draw-priority: 25`
            - ğŸ˜ï¸ AÃ±adir POIs a Ã¡reas (`--add-pois-to-areas`)
            - ğŸ”— Vincular POIs a vÃ­as (`--link-pois-to-ways`)
            - ğŸ”„ Preservar orden de elementos (`--preserve-element-order`)
            - ğŸ—‚ï¸ Carpeta `bounds/`
            - ğŸŒŠ Carpeta `sea/`
            - ğŸŒ Generar mar como polÃ­gonos (`--generate-sea=polygons`)
            - ğŸ“¢ Modo detallado (`--verbose`)

          files: |
            output/peninsula/peninsula-gmapsupp.img
            output/canarias/canarias-gmapsupp.img
            output/baleares/baleares-gmapsupp.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Send Telegram notification
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHATID: ${{ secrets.TELEGRAM_CHATID }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          BUILD_STATUS: ${{ job.status }}
          OSM_DATE: ${{ steps.release-getdate-osm.outputs.DATE_OSM }}
        run: |
          STATUS_EMOJI="âœ…"
          if [ "$BUILD_STATUS" != "success" ]; then
            STATUS_EMOJI="âŒ"
          fi

          MESSAGE=$(printf "<b> ğŸ›°ï¸ OpenStreetMaps for Garmin eTrex, build: %s %s</b>\n\n \
          ğŸ“… <b>Fecha OSM compilaciÃ³n:</b> \n\t\t\t\t\t\t\t %s\n \
          ğŸ”— <a href=\"https://github.com/azagramac/OSMforGarmin/actions/runs/%s\">Ver detalles en GitHub</a>" "$STATUS_EMOJI" "${BUILD_STATUS^}" "$OSM_DATE" "$GITHUB_RUN_ID")

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHATID}" \
            --data-urlencode "parse_mode=HTML" \
            --data-urlencode "text=$MESSAGE" >/dev/null 2>&1

      - name: ğŸ§¹ Clean up temporary files and folders
        if: always()
        run: |
          echo "Cleaning up temporary directories..."
          rm -rf data tools output split bounds sea *.zip
          echo "Cleanup completed."
